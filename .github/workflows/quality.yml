name: Quality Gate

on:
  pull_request:
  push:
    branches:
      - main
      - release/**
      - feature/**
      - features/**
      - user/**
      - users/**
      - hotfix/**

jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      COVERAGE_THRESHOLD_LINE: 52
      COVERAGE_THRESHOLD_BRANCH: 29
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore Incursa.Core.slnx

      - name: Verify type specs are present
        shell: pwsh
        run: ./scripts/verify-type-specs.ps1

      - name: Verify formatting and analyzers
        run: dotnet format --verify-no-changes Incursa.Core.slnx

      - name: Build (deterministic)
        run: dotnet build Incursa.Core.slnx --no-restore --configuration Release -warnaserror -p:ContinuousIntegrationBuild=true

      - name: Test with coverage gate
        run: |
          # Ratcheting baseline: increase these values toward long-term 85/85 as coverage expands.
          dotnet test Incursa.Core.slnx \
            --no-build \
            --configuration Release \
            /p:CollectCoverage=true \
            /p:CoverletOutput=./TestResults/Coverage/ \
            /p:CoverletOutputFormat=cobertura \
            /p:Threshold=${COVERAGE_THRESHOLD_LINE}%2c${COVERAGE_THRESHOLD_BRANCH} \
            /p:ThresholdType=line%2cbranch \
            /p:ThresholdStat=total

      - name: Create coverage summary
        run: |
          dotnet tool install --tool-path .tools dotnet-reportgenerator-globaltool --version 5.*
          ./.tools/reportgenerator \
            "-reports:**/coverage.cobertura.xml" \
            "-targetdir:artifacts/coverage-report" \
            "-reporttypes:HtmlInline;MarkdownSummaryGithub"
          cat artifacts/coverage-report/SummaryGithub.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: artifacts/coverage-report

      - name: Pack (repro 1)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf artifacts/repro1 artifacts/repro2
          mkdir -p artifacts/repro1 artifacts/repro2

          dotnet pack ./Incursa.Core.slnx \
            -c Release \
            -p:ContinuousIntegrationBuild=true \
            -p:Deterministic=true \
            -p:EmbedUntrackedSources=true \
            -p:PackageVersion=0.0.1-ci \
            -o artifacts/repro1 \
            --no-restore

      - name: Pack (repro 2)
        shell: bash
        run: |
          set -euo pipefail
          dotnet pack ./Incursa.Core.slnx \
            -c Release \
            -p:ContinuousIntegrationBuild=true \
            -p:Deterministic=true \
            -p:EmbedUntrackedSources=true \
            -p:PackageVersion=0.0.1-ci \
            -o artifacts/repro2 \
            --no-restore


      - name: Compare nupkg contents (normalized, multi-package)
        id: compare
        shell: bash
        run: |
          set -euo pipefail

          # Creates a deterministic "manifest" for a .nupkg by hashing the extracted contents,
          # excluding known non-deterministic OPC metadata produced by NuGet pack.
          normalize_manifest() {
            local nupkg="$1"
            local out="$2"
            local dir
            dir="$(mktemp -d)"

            unzip -q "$nupkg" -d "$dir"

            # Remove known non-deterministic pack metadata:
            # - OPC core-properties part name is GUID-based
            # - _rels/.rels references that GUID-based part name
            rm -f "$dir/_rels/.rels" || true
            rm -f "$dir/package/services/metadata/core-properties/"*.psmdcp || true

            # Hash remaining files deterministically (stable ordering)
            (
              cd "$dir"
              find . -type f -print0 | sort -z | xargs -0 sha256sum
            ) > "$out"

            rm -rf "$dir"
          }

          # Compare two packages and print a useful diff (file list + per-file hash diff)
          compare_packages() {
            local p1="$1"
            local p2="$2"
            local name="$3"

            local m1="/tmp/${name}.repro1.manifest"
            local m2="/tmp/${name}.repro2.manifest"

            normalize_manifest "$p1" "$m1"
            normalize_manifest "$p2" "$m2"

            if ! diff -u "$m1" "$m2" >/tmp/${name}.diff; then
              echo "::group::❌ Package differs (normalized): $name"
              echo "repro1: $p1"
              echo "repro2: $p2"
              echo ""
              echo "Diff (sha256sum lines):"
              cat "/tmp/${name}.diff"
              echo "::endgroup::"
              return 1
            else
              echo "✅ Deterministic (normalized): $name"
            fi
          }

          mkdir -p /tmp/nupkg-diff

          # Collect all nupkgs in each folder
          mapfile -t P1 < <(ls -1 artifacts/repro1/*.nupkg 2>/dev/null | sort)
          mapfile -t P2 < <(ls -1 artifacts/repro2/*.nupkg 2>/dev/null | sort)

          if [[ "${#P1[@]}" -eq 0 || "${#P2[@]}" -eq 0 ]]; then
            echo "No .nupkg files found in one or both directories."
            echo "repro1 count: ${#P1[@]}"
            echo "repro2 count: ${#P2[@]}"
            exit 1
          fi

          # Compare sets by filename (basename)
          printf "%s\n" "${P1[@]##*/}" | sort > /tmp/repro1.names
          printf "%s\n" "${P2[@]##*/}" | sort > /tmp/repro2.names

          if ! diff -u /tmp/repro1.names /tmp/repro2.names >/tmp/nupkg-names.diff; then
            echo "::group::❌ Package sets differ between repro1 and repro2"
            cat /tmp/nupkg-names.diff
            echo "::endgroup::"
            exit 1
          fi

          # Build lookup maps basename -> full path
          declare -A MAP1 MAP2
          for p in "${P1[@]}"; do MAP1["$(basename "$p")"]="$p"; done
          for p in "${P2[@]}"; do MAP2["$(basename "$p")"]="$p"; done

          # Compare each package
          failed=0
          while IFS= read -r name; do
            if ! compare_packages "${MAP1[$name]}" "${MAP2[$name]}" "$name"; then
              failed=1
            fi
          done < /tmp/repro1.names

          if [[ "$failed" -ne 0 ]]; then
            echo ""
            echo "One or more packages were not deterministic (normalized)."
            exit 1
          fi

      - name: Upload normalized package diffs
        if: failure() && steps.compare.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: nupkg-normalized-diffs
          path: |
            /tmp/*.manifest
            /tmp/*.diff
            /tmp/repro1.names
            /tmp/repro2.names
            /tmp/nupkg-names.diff

  mutation:
    name: Mutation Testing (Stryker)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: verify
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore Incursa.Core.slnx

      - name: Install Stryker
        run: dotnet tool install --tool-path .tools dotnet-stryker --version 4.9.0

      - name: Run mutation tests
        run: |
          ./.tools/dotnet-stryker \
            -p Incursa.Types/Incursa.Types.csproj \
            -tp Incursa.Types.Tests/Incursa.Types.Tests.csproj \
            -l Basic \
            -L \
            -b 70 \
            --threshold-low 70 \
            --threshold-high 85 \
            --break-on-initial-test-failure \
            -r Progress \
            -r Html \
            -r Markdown \
            -O artifacts/stryker \
            --skip-version-check

      - name: Upload mutation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: artifacts/stryker
