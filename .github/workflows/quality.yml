name: Quality Gate

on:
  pull_request:
  push:
    branches:
      - main
      - release/**
      - feature/**
      - features/**
      - user/**
      - users/**
      - hotfix/**

jobs:
  verify:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore Bravellian.Core.slnx

      - name: Verify formatting and analyzers
        run: dotnet format --verify-no-changes Bravellian.Core.slnx

      - name: Build (deterministic)
        run: dotnet build Bravellian.Core.slnx --no-restore --configuration Release -warnaserror -p:ContinuousIntegrationBuild=true

      - name: Test
        run: dotnet test Bravellian.Core.slnx --no-build --configuration Release

      - name: Pack (repro 1)
        run: |
            rm -rf artifacts/repro1 artifacts/repro2
            mkdir -p artifacts/repro1 artifacts/repro2
            dotnet pack ./Bravellian.Types/Bravellian.Types.csproj \
            -c Release \
            -p:ContinuousIntegrationBuild=true \
            -p:Deterministic=true \
            -p:EmbedUntrackedSources=true \
            -p:PackageVersion=0.0.1-ci \
            -o artifacts/repro1

      - name: Pack (repro 2)
        run: |
            dotnet pack ./Bravellian.Types/Bravellian.Types.csproj \
            -c Release \
            -p:ContinuousIntegrationBuild=true \
            -p:Deterministic=true \
            -p:EmbedUntrackedSources=true \
            -p:PackageVersion=0.0.1-ci \
            -o artifacts/repro2

      - name: Compare nupkg hash
        id: compare
        run: |
            sha256sum artifacts/repro1/*.nupkg > /tmp/repro1.sha
            sha256sum artifacts/repro2/*.nupkg > /tmp/repro2.sha
            diff /tmp/repro1.sha /tmp/repro2.sha

      # Only if the compare fails, extract and diff the contents
      - name: Diagnose non-deterministic nupkg
        if: failure() && steps.compare.outcome == 'failure'
        run: |
            mkdir -p /tmp/p1 /tmp/p2
            unzip -q artifacts/repro1/*.nupkg -d /tmp/p1
            unzip -q artifacts/repro2/*.nupkg -d /tmp/p2

            echo "=== file list diff ==="
            diff -qr /tmp/p1 /tmp/p2 || true

            echo "=== per-file hash diff ==="
            ( cd /tmp/p1 && find . -type f -print0 | sort -z | xargs -0 sha256sum ) > /tmp/p1.sha
            ( cd /tmp/p2 && find . -type f -print0 | sort -z | xargs -0 sha256sum ) > /tmp/p2.sha
            diff /tmp/p1.sha /tmp/p2.sha || true

            echo "=== done ==="

      - name: Upload diagnosis artifacts
        if: failure() && steps.compare.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
            name: nupkg-determinism-diff
            path: |
              /tmp/p1
              /tmp/p2
              /tmp/p1.sha
              /tmp/p2.sha
              /tmp/repro1.sha
              /tmp/repro2.sha

      - name: Validate package integrity
        run: dotnet nuget verify "artifacts/repro1/*.nupkg" --verify-attributes
